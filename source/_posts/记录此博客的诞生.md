---
title: 记录此博客的诞生
urlname: the-birth-of-the-blog
date: 2018-02-02 11:37:55
category: 工具
tags: tool
photos: /images/appveyor_build.png
---

在决定写自己的博客时，了解了几款市面上的博客系统，最后选择了使用人数多、自由度高的 [Hexo](https://hexo.io/zh-cn/docs/)

<!-- more -->

## Hexo

> Hexo 使用 Markdown（或其他渲染引擎）解析文章，在几秒内，即可利用靓丽的主题生成静态网页

#### Hexo 使用步骤

直接用 NPM 全局安装，方便使用 CLI 命令：

```npm
npm install -g hexo-cli
```

``` bash
hexo new '这是新文章的标题'
```

可以用如下命令在本地运行，预览效果：

``` bash
D:\WWW\blog-source>hexo server
INFO  Validating config
INFO  Start processing
INFO  Hexo is running at http://localhost:4000/. Press Ctrl+C to stop.
```

在新增修改完成后，使用这个命令来生成真实的 HTML/CSS 文件

``` bash
hexo generate
```

你可以在配置文件 *_config.yml* 指定一个仓库地址，例如

```yml
# Deployment
## Docs: https://hexo.io/docs/deployment.html
deploy:
  type: git
  repo: https://github.com/liluoao/liluoao.github.io.git
  branch: master
```

然后使用如下命令来部署过去

``` bash
hexo deploy
```

#### 维护缺陷

为了把博客部署更新，我每次都需要把整个的博客静态文件生成好，并提交到 GIT 上，再去服务器上把整个博客 PULL 下来

那么有没有办法让这个流程变的智能些，让我可以从搭建流程脱离出来呢？接下来就介绍下我的解决方案

## CI

#### 持续集成介绍

持续集成（Continuous integration，简称 CI）是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，从而尽早地发现集成错误。

减少重复的过程可以节省时间、费用和工作量。说起来简单，做起来难。这些浪费时间的重复劳动可能在我们的项目活动的任何一个环节发生，包括代码编译、数据库集成、测试、审查、部署及反馈。通过自动化的持续集成可以将这些重复的动作都变成自动化的，无需太多人工干预，让人们的时间更多的投入到动脑筋的、更高价值的事情上。

市面上常见的持续集成工具有 [Jenkins](https://jenkins.io/zh/)，[TravisCI](https://www.travis-ci.org/)，和本文要使用的 [AppVeyor](https://ci.appveyor.com)（一般代码管理平台也支持 CI/CD）

#### 配置项目

可以使用 GitHub 账号授权登陆，快速导入自己的项目。在 `/projects` 页面选择你的博客源码仓库

点击项目中 `SETTINGS` 选项卡，如果项目分支不是默认的，修改 `Default branch` 

再点击 `Environment` 栏目，设置如下 4 个环境变量：

![项目环境变量](/images/appveyor_project_env.png)

变量解释：

|name|value|
|---|---|
|STATIC_SITE_REPO|静态页面的仓库地址|
|TARGET_BRANCH|编译后文件存放的分支|
|GIT_USER_EMAIL|Github用户邮箱|
|GIT_USER_NAME|Github用户名|

#### 获取 GitHub 的 Token

打开 GitHub 个人设置

点击 `Developer settings` 栏目，再点击 `Personal access tokens` 选项卡，可以看到已有的 Token

这里点击 `Generate new token` 按钮创建一个博客专用的 Token

![个人TOKEN](/images/github_token.png)

由于这个 Token 可以直接操作代码仓库，而且项目的配置文件是公开的，所以最好对它进行加密

AppVeyor 提供了专门的[加密功能](https://ci.appveyor.com/tools/encrypt)，如下

![TOKEN加密](/images/appveyor_encrypt.png)

#### 配置构建命令

在项目中新建 AppVeyor 的指定配置文件 *appveyor.yml*，以我的配置为例：

```yml appveyor.yml
clone_depth: 5

environment:
    access_token:
        secure: # 自己的加密token
install:
    - ps: Install-Product node 6.9 # 默认node版本太老，具体版本根据包要求来
    - node --version
    - npm --version
    - npm install
    - npm install hexo-cli -g

build_script:
    - hexo generate

artifacts:
    - path: public

on_success:
    - git config --global credential.helper store
    - ps: Add-Content "$env:USERPROFILE\.git-credentials" "https://$($env:access_token):x-oauth-basic@github.com`n"
    - git config --global user.email "%GIT_USER_EMAIL%"
    - git config --global user.name "%GIT_USER_NAME%"
    - git clone --depth 5 -q --branch=%TARGET_BRANCH% %STATIC_SITE_REPO% %TEMP%\static-site
    - cd %TEMP%\static-site
    - del * /f /q
    - for /d %%p IN (*) do rmdir "%%p" /s /q
    - SETLOCAL EnableDelayedExpansion & robocopy "%APPVEYOR_BUILD_FOLDER%\public" "%TEMP%\static-site" /e & IF !ERRORLEVEL! EQU 1 (exit 0) ELSE (IF !ERRORLEVEL! EQU 3 (exit 0) ELSE (exit 1))
    - git add -A
    - git commit -m "" # 自定义注释
    - git push origin %TARGET_BRANCH%
    - appveyor AddMessage "Static Site Updated"
```

意思是从仓库的当前分支拉取下来，使用 `hexo generate` 命令编译成静态文件后，再 push 到目标项目

> 由于 Hexo 自带的部署 `hexo g -d` 在访问的过程中需要我们输入帐号密码，所以不适合在这里使用

持续集成实现后，我可以随时随地把博客源文件项目（blog-source）给 PULL 下来写文章，提交后 AppVeyor 会根据源文件来生成最新的静态文件，并自动提交到展示项目（liluoao.github.io）中

## 服务器搭建

~~在阿里云购买了服务器后，把自己的博客放了上去~~（已过期未续费）。系统为Ubuntu 16.4，需要安装基础环境

```bash
# 阿里云已配置好了源，直接更新就行
sudo apt-get update
# 安装Web服务器
sudo apt-get install nginx
sudo apt-get install apache2
```

根据提示符，输入 Y 确认后，开始安装软件，直至软件安装完成

软件安装完成后，通过通过 `dpkg -L` 列出软件包所在的目录，及该软件包中的所有文件

```bash
sudo /etc/init.d/apache2 start
# 安装Git
sudo apt-get install git
# 生成 SSH key
ssh-keygen -t rsa -C "你的用户名"
```

1. 第一次提示你想将 `key` 保存到哪里，直接回车代表使用默认的 `/.ssh/id_rsa`
2. 第二次提示你设置一个口令密码，直接回车代表设为空
3. 第三次重复第二次的密码

进入 `key` 保存位置，打开 *id_rsa.pub* ，全部复制后大写模式两下 Z 退出编辑

- 进入 GitHub，打开 `Settings`
- 点击 `SSH and GPG keys` 选项卡
- 点击 `New SSH key` 按钮，将复制的 `key` 粘贴进去
- 取个能识别用途的名字，保存

回到命令行，测试 SSH key 是否配置成功：

```bash
ssh -T git@github.com
# 出现如下信息则说明成功与 GitHub 连接
Hi username! You've successfully authenticated, but GitHub does not provide shell access
```

```bash
# 配置 Git 的用户名和邮箱
git config --global user.name "用户名"
git config --global user.email "邮箱"
# 查看已有配置
git config user.name
git config user.email
```

## Apache 配置 SSL

现在浏览器不再建议使用 HTTP，会提示网站不安全，需要把网站更换为 HTTPS，并将 HTTP 访问的自动转发到 HTTPS 端口上

#### 开启SSL模块

```bash
sudo a2enmod ssl
```

这条命令相当于下面 2 条：

```bash
sudo ln -s /etc/apache2/mods-available/ssl.load /etc/apache2/mods-enabled
sudo ln -s /etc/apache2/mods-available/ssl.conf /etc/apache2/mods-enabled
```

如果没有 `a2enmod` 指令，也可以直接在配置中设置 SSL 模块加载：

```apacheconfig apache2.conf
LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
```

#### 证书

证书有两种：一种是自签名证书，另外一种是第三方 CA 机构签名证书

第一种随便使用，没有经过官方认可的机构认证。后一种则是正规的签名证书，有发证机构签名

阿里云提供了免费的自签名证书，也可以自己创建自签名证书

使用 apache 内置的工具创建默认的自签名证书，通过 **-days** 参数指定有效期：

```bash
sudo apache2-ssl-certificate
```

创建完成后，当前目录下有个 *apache.pem* 文件，已经包含密钥和证书。可以把这个证书拷贝到 */etc/apache2/* 下

#### 修改配置

安装完后，会在 */etc/apache2/sites-available/* 目录下生成一个 *default-ssl* 文件

我们可以创建一个链接到 *site-enabled* 目录

```bash
ln -s /etc/apache2/sites-available/default-ssl /etc/apache2/sites-enabled/001-ssl
```

编辑 Apache 端口配置，加入 443 端口：

```conf /etc/apache2/ports.conf
Listen 80
Listen 443
```

把端口改为 443，在 `<Virtualhost>` 下加入 SSL 认证配置，其它的根据需要定制：

```conf
<VirtualHost *:443>
    ServerAdmin liluoao@qq.com
    ServerName liluoao.com
    DocumentRoot /var/www/html
    SSLEngine on
    # 添加 SSL 协议
    SSLProtocol all -SSLv2 -SSLv3
    # 修改加密套件
    SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM
    SSLHonorCipherOrder on
    # 公钥
    SSLCertificateFile /etc/apache2/cert/public.pem
    # 私钥
    SSLCertificateKeyFile /etc/apache2/cert/1523613072453.key
    # 链配置
    SSLCertificateChainFile /etc/apache2/cert/chain.pem
</VirtualHost>
```

开启重定向需要加载 `rewrite` 模块

```bash
a2enmod rewrite
#或者用下面这句
ln -s /etc/apache2/mods-available/rewrite.load  /etc/apache2/mods-enabled/rewrite.load
```

编辑你的 HTTP 配置：

```conf
<VirtualHost *:80>
    ServerName www.liluoao.com
    ServerAdmin liluoao@qq.com
    DocumentRoot /var/www/html
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    RewriteEngine on
    RewriteCond   %{HTTPS} !=on
    RewriteRule   ^(.*)  https://%{SERVER_NAME}$1 [L,R]
</VirtualHost>
```

或者是在根目录编辑 *.htaccess* 文件：

```htaccess .htaccess
RewriteEngine on
RewriteBase /
RewriteCond %{SERVER_PORT} !^443$
RewriteRule ^.* https://%{SERVER_NAME}%{REQUEST_URI} [L,R]
```
