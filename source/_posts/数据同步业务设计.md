---
title: æ•°æ®åŒæ­¥ä¸šåŠ¡è®¾è®¡
date: 2021-03-14 16:41:33
urlname: data-sync-design
category: æ‚è°ˆ
---

ä»¥ç»„ç»‡æž¶æž„æ•°æ®ä¸ºä¾‹ï¼š

- 1. ä»Ž[åŒ—æ£®æŽ¥å£](http://openapi.italent.cn/docs/tenantbase)å®šæ—¶èŽ·å–å¢žé‡æ•°æ®
- 2. å°†æ¯ä¸€æ¡æ•°æ®æ”¾å…¥ Job å¤„ç†ï¼ŒåŸºäºŽé˜¿é‡Œäº‘ MQ
  > ç”±äºŽå…¬ç”¨ä¸€ä¸ªå®žä¾‹ï¼Œå‡ºçŽ°å¶å‘å µå¡ž
- 3. è§¦å‘ Laravel äº‹ä»¶ `event()`
- 4. æ ¹æ®é…ç½®çš„ Listenerï¼ŒæŠŠæ•°æ®ä¼ å…¥å„ä¸ªä¸šåŠ¡çº¿
  > å„æ¡çº¿æŽ¥å£çš„æ—¥å¿—æ˜¯åˆ†è¡¨å­˜æ•°æ®åº“é‡Œï¼ŒæŸ¥è¯¢æ•ˆçŽ‡ä½Ž
  > ä¾‹å¦‚ `CONVERT(parameters using 'utf8') LIKE '%123456%'`

<!-- more -->

é™¤äº†ä¸Šé¢è¯´çš„å‡ ç‚¹ç¼ºé™·ï¼Œè¿˜æœ‰ä»¥ä¸‹é—®é¢˜ï¼š

- ç”±äºŽå„ä¸šåŠ¡çº¿éƒ½æœ‰éœ€è¦å­˜å‚¨çš„ä¸šåŠ¡æ•°æ®ï¼Œè¡¨çš„è®¾è®¡æ¯”è¾ƒæ··ä¹±
- éœ€è¦å›žè°ƒè®©å¤–éƒ¨è¯·æ±‚æ—¶ï¼Œç¼ºå°‘é‰´æƒðŸ¥¶
- å¯¹æŽ¥å¤–éƒ¨çš„æµç¨‹ä¸ç»Ÿä¸€ï¼Œéžå¸¸ä¾èµ–å¯¹æ–¹çš„è¿›åº¦ðŸ˜…
- ç½‘å…³å±‚çš„å…¶å®ƒåŠŸèƒ½ï¼šé™æµã€ç†”æ–­ç­‰

![](https://cdn.jsdelivr.net/gh/liluoao/cdn@main/image/EBS.png)

## æ–‡ä»¶åŒæ­¥é—®é¢˜

ç¬¬ä¸‰ç‚¹éœ€è¦ç‰¹åˆ«æ‹¿å‡ºæ¥è¯´æ˜Žã€‚ä¸€èˆ¬åœ¨å¯¹æŽ¥å…¶å®ƒå…¬å¸æ—¶ï¼Œæœ‰æˆç†Ÿç¨³å®šçš„æ–‡æ¡£ï¼Œæ•ˆçŽ‡å°±å¾ˆé«˜ã€‚ä½†æ˜¯åŽ»å¹´åœ¨æŽ¥å…¥[ç›–é›…å·¥åœº](https://www.gaiaworks.cn/)æ—¶ï¼Œéœ€è¦æŠŠç»„ç»‡äººäº‹å¢žé‡æ•°æ®é€šè¿‡ `csv` æ–‡ä»¶ä¼ åˆ°å¯¹æ–¹çš„æœåŠ¡å™¨ï¼Œè€Œå…¶ä¸­çš„å­—æ®µéƒ½æ˜¯è‡ªå®šä¹‰çš„ã€‚

ç›®å‰çš„å‘˜å·¥æ•°é‡å·²ç»è¾¾åˆ°äº† 7kï¼Œåœ¨ç”¨ `implode()` å°†æ•°ç»„åˆ‡å‰²æˆ csv æ ¼å¼çš„å­—ç¬¦ä¸²æ—¶ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œå‡ºçŽ°ä»¥ä¸‹ä¸¥é‡é—®é¢˜ã€‚

- 1. é¢‘ç¹ä½¿ç”¨è¿œç¨‹è¿žæŽ¥ä¼šå‡ºçŽ°å¤±è´¥
- 2. å…¨é‡æ—¶æŽ¥å£ä¼šè¶…æ—¶
- 3. å¶å‘çš„å†…å®¹æ‹¼æŽ¥é”™è¯¯ï¼ˆæŸä¸€è¡Œå‡ºçŽ°åœ¨ä¸Šä¸€è¡Œçš„ä¸­é—´éƒ¨åˆ†ï¼Œå…¶å®ƒè¡Œæ­£å¸¸ï¼‰

å…ˆä¼˜åŒ–ä¸ºæŠŠéœ€è¦åŒæ­¥çš„å‘˜å·¥æ‹†åˆ†ä¸º 100 äººä¸€æ‰¹æ”¾å…¥é˜Ÿåˆ—ï¼ŒæŠŠæ•°æ®è½¬æ¢ä¸ºä¸€è¡Œæ–‡ä»¶å†…å®¹åŽï¼Œå…ˆå†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œå†æŠŠæ•´ä¸ªæœ¬åœ°æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ°è¿œç¨‹ã€‚

> äººäº‹å¶å°”åæ˜ æ•°æ®æœ‰é—®é¢˜ï¼Œè¿™æ—¶æ²¡æœ‰ä¸€ä¸ªåˆ¤æ–­ä¾æ®ï¼Œå› ä¸ºå¯¹æ–¹æ¯æ¬¡å¤„ç†å®Œæ–‡ä»¶åŽéƒ½ä¼šåˆ é™¤æŽ‰ï¼Œæˆ‘ä»¬æ”¾åœ¨æœ¬åœ°çš„æ–‡ä»¶æ¯æ¬¡é‡æ–°æž„å»ºåŽä¹Ÿä¸å­˜åœ¨

> æ›´çª’æ¯çš„æ˜¯å¯¹æ–¹æ²¡æœ‰ä¸€ä¸ªé”™è¯¯æç¤ºï¼Œç™»å½•æœåŠ¡å™¨æ‰çŸ¥é“åŒæ­¥å› ä¸ºæŠ¥é”™å¡ä½äº†ï¼šä»–ä»¬çš„é€»è¾‘æ˜¯ä¸€ä¸ªæ–‡ä»¶é‡Œé‡åˆ°ä¸€è¡Œé”™è¯¯ï¼Œå‰©ä¸‹çš„å°±ä¸æ‰§è¡Œäº†ï¼Œè€Œä¸”ä¹‹åŽçš„æ–°æ–‡ä»¶ä¹Ÿä¸æ‰§è¡Œäº†ðŸ™ƒ

æˆ‘å†³å®šä»¥å¯ç”¨æ€§æ›´é«˜çš„æ•°æ®åº“æ–¹å¼æ¥è§£å†³ï¼šæ–°å»ºä¸€å¼ è¡¨ï¼Œç”¨æ¥å­˜å‚¨å‘˜å·¥åœ¨æ–‡ä»¶ä¸­å¯¹åº”çš„ä¸€è¡Œå†…å®¹ï¼Œå†æ–°å¢žä¸€ä¸ª Listenerï¼Œåœ¨å‘˜å·¥è¿›è¡Œ CUD æ—¶å°±æ–°å¢žæˆ–ä¿®æ”¹åˆ°æ–°è¡¨ä¸­ï¼Œå®šæ—¶ä»»åŠ¡å†é€šè¿‡ä¿®æ”¹æ—¶é—´æˆ³åŽ»æŸ¥è¯¢ã€‚

æ­¤æ—¶æŠŠå†…å®¹æ•°ç»„å­˜åœ¨è¡¨ä¸­çš„ JSON å­—æ®µæ—¶ï¼Œå†å–å‡ºæ¥æ”¾åˆ°æ–‡ä»¶ä¸­æ—¶ï¼Œé¡ºåºä¼šé”™ä¹±ðŸ˜¢ï¼Œæ˜¯å› ä¸º MySQL åœ¨å­˜å‚¨ JSON æ—¶æŒ‰ç…§ KEY çš„å­—æ®µé•¿åº¦åšäº†æŽ’åºï¼Œä»¥ä¾¿èŽ·å¾—æ›´å¥½çš„å­˜å‚¨æ€§èƒ½ï¼šsee [manual](https://dev.mysql.com/doc/refman/5.7/en/json.html#json-comparison)

> To make lookups more efficient, it also sorts the keys of a JSON object. You should be aware that the result of this ordering is subject to change and not guaranteed to be consistent across releases.

æ‰€ä»¥å°±æŠŠå†…å®¹å­—æ®µç±»åž‹æ”¹ä¸º TEXTï¼Œåˆ‡å‰²å¥½äº†å†å­˜è¿›åŽ»ï¼Œå–çš„æ—¶å€™æ‹¼ä¸ªæ¢è¡Œç¬¦å°±èƒ½ç”¨äº†ã€‚

å…¶å®žè¿™ä¸ªåŒæ­¥æµç¨‹åœ¨ä¹‹å‰å·²ç»æ›´æ”¹è¿‡å‡ æ¬¡äº†ï¼Œsee [ã€ŠGolangæŽ¥æ”¶ä¸Šä¼ æ–‡ä»¶ã€‹](/posts/golang-receive-upload-file.html)ï¼š

## PHP ä½¿ç”¨ SFTP å‘é€æ–‡ä»¶

```php
$connection = ssh2_connect($this->host, $this->port);
ssh2_auth_password($connection, $this->user, $this->password);
Storage::put($filename, $csvFileContent);
$result = ssh2_scp_send(
    $connection,
    Storage::path($filename),
    $this->path.$filename,
    0644
);
ssh2_disconnect($connection);
Storage::delete($filename);
```

æƒŠè®¶çš„æ˜¯åŒä¸€ä»½ä»£ç åœ¨æµ‹è¯•æœåŠ¡å™¨ä¸Šæ­£å¸¸è¿è¡Œï¼Œåœ¨å¾€å¯¹æŽ¥å…¬å¸çš„æœåŠ¡å™¨ä¸Š SCP å°±æŠ¥é”™

**ssh2_scp_send(): Failure creating remote file: (-28)**

è€Œç”¨ IDE è‡ªå¸¦çš„è¿œç¨‹ç®¡ç†ç™»å½•åŽï¼Œè¯»å†™æƒé™éƒ½æ˜¯æ­£å¸¸çš„

è¿™ç¥žå¥‡çš„ BUG ä½“è´¨ï¼Œåˆè¯¥è¯·æ•™å¤§ä½¬äº†ï¼Œé€šè¿‡å‘½ä»¤è¡Œæµ‹è¯•ï¼š

```bash
scp -v -P whichPort localFile whoYouAre@address:remoteFile
...
exec request failed on channel 0
lost connection
```

æ”¹ç”¨ sftp å‘½ä»¤è¿žæŽ¥ä¸Šå†å†™æ–‡ä»¶æ˜¯æ­£å¸¸çš„ï¼Œæ‰€ä»¥ä»£ç ä¿®æ”¹ä¸º

```php
$sftp = ssh2_sftp($connection);
$stream = @fopen("ssh2.sftp://$sftp$this->path/$filename", 'w+');
fwrite($stream, $fileContent);
fclose($stream);
```

## Laravel File Storage

Laravel å†…ç½®äº† Flysystem æ‰©å±•åŒ…ï¼Œèƒ½å¤Ÿä½¿ç”¨ç®€å•çš„ API æ¥æ“ä½œï¼Œæœªæ¥éœ€è¦æ›´æ¢é©±åŠ¨æ—¶ä¹Ÿæ–¹ä¾¿

> åœ¨ä½¿ç”¨ SFTP å‰éœ€è¦ä¸‹è½½ä¾èµ– league/flysystem-sftp ~1.0

åœ¨é…ç½®æ–‡ä»¶ä¸­å¢žåŠ æ­¤ â€œç£ç›˜â€ çš„é…ç½®ï¼š

```php config/filesystems.php
'disks' => [
    'remote' => [
        'driver'   => 'sftp',//Supported Drivers: "local", "ftp", "sftp", "s3"
        'host'     => env('REMOTE_HOST'),
        'port'     => env('REMOTE_PORT'),
        'username' => env('REMOTE_USER'),
        'password' => env('REMOTE_PASSWORD'),
        'root'     => env('REMOTE_PATH'),
    ],
],
```

ä½¿ç”¨é—¨é¢æ¥èŽ·å–å®žä¾‹ï¼Œä»¥èŽ·å–æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶åä¸ºä¾‹ï¼š

```php
$remoteDisk = Storage::disk('remote');
dd($remoteDisk->allFiles());
```

ä¸Šé¢çš„ä¸šåŠ¡é€»è¾‘é€šè¿‡ç®€å•çš„ 2 ä¸ªæ–¹æ³•å°±èƒ½å®Œæˆï¼š

```php
Storage::disk('remote')->put($filename, self::TABLE_HEADER . PHP_EOL);

Storage::disk('remote')->append($filename, $content);
```
